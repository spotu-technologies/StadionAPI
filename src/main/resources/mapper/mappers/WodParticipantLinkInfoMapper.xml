<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- SQL Mapping -->

<!-- mapper 인터페이스가 위치하는 경로 -->
<mapper namespace="com.stadion.api.mapper.WodParticipantLinkInfoMapper">	
    <!-- id: mapper 인터페이스에서 선언한 메서드 이름과 같아야 한다. resultType: VO 클래스가 위치하는 경로 -->
    <select id="getWodParticipantLinkInfo" resultType="com.stadion.api.entity.WodParticipantLinkInfo">	
        SELECT *
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.idx = #{idx}
    </select>
    
    <select id="getWodParticipantLinkInfoIsAttend" resultType="com.stadion.api.entity.WodParticipantLinkInfo">	
        SELECT *
        FROM (
        SELECT wpli2.*, ROW_NUMBER() OVER (PARTITION BY wpli2.accountIdx ORDER BY wpli2.accountIdx) AS rn
        FROM stadion_db_dev.wodParticipantLinkInfo wpli1
        INNER JOIN stadion_db_dev.wodParticipantLinkInfo wpli2 ON wpli1.wodIdx = wpli2.wodIdx
        INNER JOIN stadion_db_dev.wodInfo wi ON wpli1.wodIdx = wi.idx
        WHERE wpli1.accountIdx = #{accountIdx}
        AND wpli2.isAttend = 'Y'
        AND YEAR(wi.progressDate) = YEAR(CURRENT_DATE())
        AND MONTH(wi.progressDate) = MONTH(CURRENT_DATE())
        ) AS subquery
        WHERE rn = 1;
        	
    </select>
    
    
    <select id="getWodParticipantLinkInfoIsNonappearance" resultType="com.stadion.api.entity.WodParticipantLinkInfo">	
        SELECT *
        FROM (
        SELECT wpli2.*, ROW_NUMBER() OVER (PARTITION BY wpli2.accountIdx ORDER BY wpli2.accountIdx) AS rn
        FROM stadion_db_dev.wodParticipantLinkInfo wpli1
        INNER JOIN stadion_db_dev.wodParticipantLinkInfo wpli2 ON wpli1.wodIdx = wpli2.wodIdx
        INNER JOIN stadion_db_dev.wodInfo wi ON wpli1.wodIdx = wi.idx
        WHERE wpli1.accountIdx = #{accountIdx}
        AND wpli2.isAttend = 'N'
        AND YEAR(wi.progressDate) = YEAR(CURRENT_DATE())
        AND MONTH(wi.progressDate) = MONTH(CURRENT_DATE())
        ) AS subquery
        WHERE rn = 1;
        	
    </select>

	<select id="getwodParticipantCount" resultType="Long">	
        SELECT count(*)
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.wbLinkIdx = #{idx}
        	and status = 1
    </select>

	<select id="getwodParticipantReserved" resultType="Long">	
        SELECT count(*)
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.wbLinkIdx = #{idx} 
        	and accountIdx=#{accountIdx}
    </select>
    
    <select id="getWodParticipantAttend" resultType="Long">	
        SELECT count(*)
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.wodIdx = #{idx} 
        	 and isAttend='Y' and status=1
    </select>
    
    <select id="getwodParticipantStatus" resultType="Long">	
        SELECT status
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.wbLinkIdx = #{idx} 
        	and accountIdx=#{accountIdx}
    </select>
    
    
    <update id="cancelWodParticipantLinkInfo">	
        UPDATE wodParticipantLinkInfo 
        <set>
			status = 9
        </set>
        	WHERE  idx = #{idx}         	
    </update>
    
    <update id="reserveWodParticipantLinkInfo">	
        UPDATE wodParticipantLinkInfo 
        <set>
			status = 1
        </set>
        	WHERE  idx = #{idx}         	
    </update>    
    
    <select id="getwodParticipantIdx" resultType="Long">	
        SELECT idx
        FROM wodParticipantLinkInfo
        	WHERE wodParticipantLinkInfo.wbLinkIdx = #{wbLinkIdx} 
        	and accountIdx=#{accountIdx}
    </select>

	<insert id="insertWodParticipantLinkInfo" parameterType="com.stadion.api.entity.WodParticipantLinkInfo">
		INSERT INTO wodParticipantLinkInfo
 			(wodIdx, boxIdx,   
        <if test="wbLinkIdx != 0 and wbLinkIdx != null">
            wbLinkIdx,
        </if>
        <if test="accountIdx != 0 and accountIdx != null">
            accountIdx,
        </if>
 			writer, status, regUnixtime, lastUpdatetime
			) 
			
			VALUES 
			 (
			 #{wodIdx}, #{boxIdx},   
        <if test="wbLinkIdx != 0 and wbLinkIdx != null">
            #{wbLinkIdx},
        </if>
        <if test="accountIdx != 0 and accountIdx != null">
            #{accountIdx},
        </if>
 			#{writer}, #{status}, UNIX_TIMESTAMP(), UNIX_TIMESTAMP() 
        	);
	</insert>

</mapper>
